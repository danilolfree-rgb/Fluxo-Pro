<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aura | Controle Financeiro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="app_style.css">
    <link rel="stylesheet" href="style/navbar.css">
    <link rel="stylesheet" href="style/cards.css">
    <link rel="stylesheet" href="style/global.css">
    <link rel="stylesheet" href="style/modais.css">
    <link rel="stylesheet" href="style/buttons-action.css">
</head>

<body>
    <!-- Barra superior -->
    <nav class="navbar-aura">
        <div class="nav-container">
            <div class="logo-aura">
                <div class="logo-icon">A</div>
                <span>AURA</span>
            </div>
            <select id="mesGlobal"></select>
        </div>
    </nav>

    <!-- Container de informa√ß√µes requisitadas do database -->
    <div class="container px-4">
        <div class="header-section mb-4">
            <h4 id="tituloSaudacao" style="font-weight: 800;">Ol√°!</h4>
            <p style="color: var(--text-muted); font-size: 14px;">Aqui est√° seu resumo financeiro.</p>
        </div>

        <div class="row g-3">
            <div class="col-12">
                <div class="card-resumo principal">
                    <small>Balan√ßo Mensal</small>
                    <h1 id="saldoTotal">R$ 0,00</h1>
                </div>
            </div>
            <div class="col-6">
                <div class="card-resumo">
                    <small>Quanto sobrou</small>
                    <h3 id="resumoGanhos" style="color: var(--success);">R$ 0,00</h3>
                </div>
            </div>
            <div class="col-6">
                <div class="card-resumo">
                    <small>Gastos</small>
                    <h3 id="resumoGastos" style="color: var(--danger);">R$ 0,00</h3>
                </div>
            </div>
        </div>

        <!-- Bot√µes que abrem os modais de envio de informa√ß√µes -->
        <div class="action-grid-mini">
            <button class="btn-mini" data-bs-toggle="modal" data-bs-target="#modalGasto"><i>üìâ</i> Gasto</button>
            <button class="btn-mini" data-bs-toggle="modal" data-bs-target="#modalRenda"><i>üí∞</i> Renda</button>
            <button class="btn-mini" data-bs-toggle="modal" data-bs-target="#modalReserva"><i>üè¶</i> Reserva</button>
        </div>
    </div>

    <!-- Modal que envia informa√ß√µes sobre gastos do usu√°rio -->
    <div class="modal fade" id="modalGasto" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-0">
                    <h6 class="fw-bold">NOVO GASTO</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-0">
                    <label class="form-label text-muted small">Descri√ß√£o</label>
                    <input type="text" id="descGasto" class="form-control mb-3" placeholder="Ex: Mercado">

                    <label class="form-label text-muted small">Valor</label>
                    <input type="number" id="valGasto" class="form-control mb-3" placeholder="R$ 0,00">

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label text-muted small">Data</label>
                            <input type="date" id="dataGasto" class="form-control">
                        </div>
                        <div class="col-6">
                            <label class="form-label text-muted small">Categoria</label>
                            <select id="catGasto" class="form-select">
                                <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                                <option value="Casa">Moradia</option>
                                <option value="Lazer">Lazer</option>
                                <option value="Transporte">Transporte</option>
                            </select>
                        </div>
                    </div>

                    <label class="form-label text-muted small">Forma de Pagamento</label>
                    <select id="pagGasto" class="form-select mb-4">
                        <option value="Pix">Pix</option>
                        <option value="Cr√©dito">Cart√£o de Cr√©dito</option>
                        <option value="D√©bito">Cart√£o de D√©bito</option>
                        <option value="Dinheiro">Dinheiro</option>
                    </select>

                    <button onclick="enviar('gasto')" id="btnSalvarGasto"
                        class="btn btn-primary w-100 p-3 rounded-4 fw-bold">SALVAR LAN√áAMENTO</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal que enviar informa√ß√µes de renda do usu√°rio -->
    <div class="modal fade" id="modalRenda" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-0">
                    <h6 class="fw-bold text-success">REGISTRAR ENTRADA</h6><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-0">
                    <select id="catRenda" class="form-select mb-3">
                        <option value="Sal√°rio">Sal√°rio</option>
                        <option value="Extra">Renda Extra</option>
                    </select>
                    <input type="number" id="valRenda" class="form-control mb-3" placeholder="Valor R$">
                    <button onclick="enviar('renda')" id="btnSalvarRenda"
                        class="btn btn-success w-100 p-3 rounded-4 fw-bold">CONFIRMAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal que envia informa√ß√µes da reserva do usu√°rio -->
    <div class="modal fade" id="modalReserva" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-0">
                    <h6 class="fw-bold text-info">NOVA RESERVA</h6><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-0">
                    <input type="text" id="descReserva" class="form-control mb-3" placeholder="Objetivo da reserva">
                    <input type="number" id="valReserva" class="form-control mb-3" placeholder="Valor R$">
                    <button onclick="enviar('reserva')" id="btnSalvarReserva"
                        class="btn btn-info w-100 p-3 rounded-4 fw-bold">GUARDAR</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>

        // URLs para acesso no database do supabase
        const SUPABASE_URL = 'https://zxftraxyutwmjoreonsa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4ZnRyYXh5dXR3bWpvcmVvbnNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNDgzMzMsImV4cCI6MjA4MjcyNDMzM30.noOBeBltO9Bsze5Q9SWTOhHAf7tfT4hB4ozwxvXc0Fo';
        const s_client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Verifica o nome do usu√°rio e guarda no localstorage
        // Busca o m√™s atual
        // Ajusta o texto de sauda√ß√£o com o nome do usu√°rio
        window.onload = async function () {
            configurarMeses();
            let nome = localStorage.getItem('nomeAuraUser') || prompt("Seu nome:");
            if (nome) {
                localStorage.setItem('nomeAuraUser', nome);
                document.getElementById('tituloSaudacao').innerText = `Ol√°, ${nome}`;
            }
            if (document.getElementById('dataGasto')) document.getElementById('dataGasto').valueAsDate = new Date();
            atualizarDashboard();
        };

        // Recebe o m√™s que o usu√°rio selecionou
        // Trata o m√™s e joga para a fun√ß√£o que atualiza os dados
        function configurarMeses() {
            const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const select = document.getElementById('mesGlobal');
            meses.forEach((m, i) => {
                let opt = document.createElement('option');
                opt.value = m; opt.innerText = m;
                if (i === new Date().getMonth()) opt.selected = true;
                select.appendChild(opt);
            });
            select.onchange = atualizarDashboard;
        }

        // Fun√ß√£o que atualiza os dados do usu√°rio na tela
        async function atualizarDashboard() {
            const mes = document.getElementById('mesGlobal').value;
            const { data, error } = await s_client.from('Lan√ßamentos').select('*').eq('mes', mes);

            if (error) return console.error(error);

            let gnh = 0, gst = 0;
            data.forEach(i => {
                if (i.tipo === 'renda') gnh += i.valor;
                if (i.tipo === 'gasto') gst += i.valor;
            });

            document.getElementById('saldoTotal').innerText = (gnh - gst).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('resumoGanhos').innerText = gnh.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('resumoGastos').innerText = gst.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Fun√ß√£o que envia os dados para o database
        async function enviar(tipo) {
            const btnId = tipo === 'gasto' ? 'btnSalvarGasto' : (tipo === 'renda' ? 'btnSalvarRenda' : 'btnSalvarReserva');
            const btn = document.getElementById(btnId);
            const dados = { tipo, mes: document.getElementById('mesGlobal').value };

            try {
                if (tipo === 'gasto') {
                    dados.descricao = document.getElementById('descGasto').value;
                    dados.valor = parseFloat(document.getElementById('valGasto').value);
                    dados.data = document.getElementById('dataGasto').value;
                    dados.categoria = document.getElementById('catGasto').value;
                    dados.pagamento = document.getElementById('pagGasto').value;
                } else if (tipo === 'renda') {
                    dados.valor = parseFloat(document.getElementById('valRenda').value);
                    dados.categoria = document.getElementById('catRenda').value;
                    dados.descricao = "Entrada";
                } else if (tipo === 'reserva') {
                    dados.valor = parseFloat(document.getElementById('valReserva').value);
                    dados.descricao = document.getElementById('descReserva').value;
                    dados.categoria = "Investimento";
                }

                if (!dados.valor) return alert("Insira um valor");
                btn.disabled = true; btn.innerText = "PROCESSANDO...";

                const { error } = await s_client.from('Lan√ßamentos').insert([dados]);
                if (error) throw error;

                location.reload();
            } catch (err) {
                alert("Erro: " + err.message);
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>